#!/bin/bash

# iprofiler
# Shim script for invoking this tool through xcode-select
#
# Copyright (c) 2007-2011 Apple Inc. All Rights Reserved.
#

rel_tool_path="usr/bin/iprofiler"
xcode_select_path="/usr/bin/xcode-select"


if [ ! -f "$xcode_select_path" ]; then
	echo "Error: $xcode_select_path not found." >&2
	exit 1
elif [ ! -x "$xcode_select_path" ]; then
	echo "Error: Can't execute $xcode_select_path." >&2
	exit 1
fi

xcode_folder=`$xcode_select_path -print-path`

if [ $? -ne 0 ]; then
	echo "Error: $xcode_select_path returned unexpected error."
	exit 1
fi

if [ ! -d "$xcode_folder" ]; then
	echo "Error: No developer directory found at $xcode_folder. Run $xcode_select_path to update the developer directory path." >&2
	exit 1
fi

tool_path="${xcode_folder}/${rel_tool_path}"
# Support coexistence of Xcode 4.3 with previous Xcode's iprofiler
old_tool_path="/Library/Developer/4.0/Instruments/bin/iprofiler"

if [ ! -f "${tool_path}" ]; then
    if [ ! -f "${old_tool_path}" ]; then
        echo "Error: Can't run ${tool_path} (no such file)." >&2
        exit 1
    else
        tool_path="${old_tool_path}"
    fi
fi
if [ ! -x "${tool_path}" ]; then
	echo "Error: Can't execute ${tool_path}." >&2
	exit 1
fi

exec "$tool_path" "$@"

# Unreachable unless exec fails
echo "Error: Couldn't exec $tool_path." >&2
exit 1
